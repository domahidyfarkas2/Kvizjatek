<!doctype html>
<html lang="hu">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Classical Quiz Player</title>

<style>
  body{font-family:system-ui,Arial;max-width:720px;margin:20px auto;padding:16px}
  .screen{display:none}
  .visible{display:block}
  button{padding:10px 14px;margin:6px 4px;font-size:16px}
  .big{font-size:20px}
  .center{text-align:center}
  #progress{width:100%;height:10px;background:#eee;border-radius:6px;overflow:hidden}
  #progress>div{height:100%;width:0%;background:linear-gradient(#ddd,#bbb)}
</style>
</head>
<body>
<h2>Tippelj! Ha a zeneszerzőt és a darabot is eltalálod, az 2 pontot ér, ha csak az egyiket, az egyet.</h2>

<div id="screen1" class="screen">
  <div id="playingInfo" class="center"></div>
  <div id="progress"><div id="progFill"></div></div>
  <div class="center">
    <button id="playBtn">Play</button>
    <button id="answerBtn" class="big">Szabad a gazda?</button>
  </div>
  <div id="hint" class="center" style="color:#555;margin-top:8px"></div>
</div>

<div id="screen2" class="screen">
  <div id="answerText" style="font-size:18px;margin-bottom:12px"></div>
  <div id="miniGameBtnWrap"></div>
  <div style="margin-top:12px">
    <a href="#" id="backToPlay">Vissza</a>
  </div>
</div>

<div id="screen3" class="screen">
  <div id="miniAnswerText" style="font-size:18px;margin-bottom:12px"></div>
  <div>
    <button id="nextMiniBtn">Kérem a következőt!</button>
    <button id="exitMiniBtn">Kilépés</button>
  </div>
</div>

<audio id="audio" preload="auto"></audio>

<script>
/* -------------------- CONFIG -------------------- */
const tracks = {
  "track001": {title:"Masques", composer:"Debussy", url:"https://pub-2773806ec26d42008de0aaedc88c2e6f.r2.dev/Debussy - Masques.mp3"},
  "track002": {title:"Bagatelle sans tonalité", composer:"Liszt", url:"https://pub-2773806ec26d42008de0aaedc88c2e6f.r2.dev/Franz Liszt - Bagatelle sans tonalité, S.216a (Gardon).mp3"},
  "track003": {title:"C-moll fantázia", composer:"Mozart", url:"https://pub-2773806ec26d42008de0aaedc88c2e6f.r2.dev/Wolfgang Amadeus Mozart - Fantasia No. 4 in C Minor, K. 475 [Complete] (Piano Solo).mp3"},
  "track004": {title:"A Walkürök lovaglása", composer:"Wagner", url:"https://pub-2773806ec26d42008de0aaedc88c2e6f.r2.dev/Wagner a walkürök lovaglása.mp3", minigame:"mini1"},
  "track010": {title:"...", composer:"Various", url:"https://example-cloud.com/audio/mini-starter.mp3", minigame:"mini1"}
};

const minigames = {
  /* mini1: Wagner vezérmotívumok minigame */
    
  "mini1": {
    tracks: ["m1.1","m1.2","m1.3","m1.4","m1.5","m1.6","m1.7","m1.8","m1.9","m1.10","m1.11","m1.12","m1.13","m1.14","m1.15","m1.16",],
    limit: 5 // ciklusok maximális limitje
  };

const extraTracks = {
  "m1.1": {title:"Valhalla (A Rajna kincse)", composer:"Richard Wagner", url:"https://pub-2773806ec26d42008de0aaedc88c2e6f.r2.dev/Wagner minigame/12a Valhalla (first segment) _ Der Ring Des Nibelungen [Man7MwIHYSw].mp3"},
  "m1.2": {title:"Wotan dárdája (A Rajna kincse)", composer:"Richard Wagner", url:"https://pub-2773806ec26d42008de0aaedc88c2e6f.r2.dev/Wagner minigame/13 Spear _ Der Ring Des Nibelungen.mp3"},
  "m1.3": {title:"óriások (A Rajna kincse)", composer:"Richard Wagner", url:"https://pub-2773806ec26d42008de0aaedc88c2e6f.r2.dev/Wagner minigame/16 Giants _ Der Ring Des Nibelungen.mp3"},
  "m1.4": {title:"Loge (A Rajna kincse)", composer:"Richard Wagner", url:"https://pub-2773806ec26d42008de0aaedc88c2e6f.r2.dev/Wagner minigame/21 Loge _ Der Ring Des Nibelungen.mp3"},
  "m1.5": {title:"Nibelheim (A Rajna kincse)", composer:"Richard Wagner", url:"https://pub-2773806ec26d42008de0aaedc88c2e6f.r2.dev/Wagner minigame/24 Nibelheim _ Der Ring Des Nibelungen.mp3"},
  "m1.6": {title:"Tarnhelm / ködsisak (A Rajna kincse)", composer:"Richard Wagner", url:"https://pub-2773806ec26d42008de0aaedc88c2e6f.r2.dev/Wagner minigame/25 Tarnhelm _ Der Ring Des Nibelungen.mp3"},
  "m1.7": {title:"kard", composer:"Richard Wagner", url:"https://pub-2773806ec26d42008de0aaedc88c2e6f.r2.dev/Wagner minigame/37 Sword _ Der Ring Des Nibelungen.mp3"},
  "m1.8": {title:"vihar (A walkür)", composer:"Richard Wagner", url:"https://pub-2773806ec26d42008de0aaedc88c2e6f.r2.dev/Wagner minigame/40 Storm _ Der Ring Des Nibelungen [MU4nXZa4y08].mp3"},
  "m1.9": {title:"Siegmund és Sieglinde (A walkür)", composer:"Richard Wagner", url:"https://pub-2773806ec26d42008de0aaedc88c2e6f.r2.dev/Wagner minigame/43 The Drink _ Der Ring Des Nibelungen.mp3"},
  "m1.10": {title:"Hunding (A walkür)", composer:"Richard Wagner", url:"https://pub-2773806ec26d42008de0aaedc88c2e6f.r2.dev/Wagner minigame/46 Hunding _ Der Ring Des Nibelungen.mp3"},
  "m1.11": {title:"Siegmund tavaszi dala (A walkür, 1. felvonás vége)", composer:"Richard Wagner", url:"https://pub-2773806ec26d42008de0aaedc88c2e6f.r2.dev/Wagner minigame/50 Spring Song _ Der Ring Des Nibelungen.mp3"},
  "m1.12": {title:"sors-motívum (A walkür)", composer:"Richard Wagner", url:"https://pub-2773806ec26d42008de0aaedc88c2e6f.r2.dev/Wagner minigame/60 Fate _ Der Ring Des Nibelungen [eK2LxAJErr0].mp3"},
   "m1.13": {title:"Siegfried motívuma (Siegfried)", composer:"Richard Wagner", url:"https://pub-2773806ec26d42008de0aaedc88c2e6f.r2.dev/Wagner minigame/65 Siegfried _ Der Ring Des Nibelungen.mp3"},
  "m1.14": {title:"Siegfried kovács-dala  (Siegfried, 1. felvonás)", composer:"Richard Wagner", url:"https://pub-2773806ec26d42008de0aaedc88c2e6f.r2.dev/Wagner minigame/84 Siegfried's Forging Song II _ Der Ring Des Nibelungen.mp3"},
  "m1.15": {title:"Brünhilde ébredése (Siegfried, 3. felvonás vége)", composer:"Richard Wagner", url:"https://pub-2773806ec26d42008de0aaedc88c2e6f.r2.dev/Wagner minigame/91 Revival _ Der Ring Des Nibelungen.mp3"},
  "m1.16": {title:"Siegfried-idill", composer:"Richard Wagner", url:"https://pub-2773806ec26d42008de0aaedc88c2e6f.r2.dev/Wagner minigame/94 Immortal Beloved (Siegfried's Idyll) _ Der Ring Des Nibelungen.mp3"},
};

/* -------------------- DOM References -------------------- */
const audio = document.getElementById('audio');
const playBtn = document.getElementById('playBtn');
const answerBtn = document.getElementById('answerBtn');
const progFill = document.getElementById('progFill');
const hint = document.getElementById('hint');
const playingInfo = document.getElementById('playingInfo');

const screen1 = document.getElementById('screen1'); 
const screen2 = document.getElementById('screen2'); 
const screen3 = document.getElementById('screen3'); 

const answerText = document.getElementById('answerText'); 
const miniGameBtnWrap = document.getElementById('miniGameBtnWrap'); 
const backToPlay = document.getElementById('backToPlay');

const miniAnswerText = document.getElementById('miniAnswerText'); 
const nextMiniBtn = document.getElementById('nextMiniBtn'); 
const exitMiniBtn = document.getElementById('exitMiniBtn'); 

/* -------------------- State Variables -------------------- */
let currentTrack = null;        
let currentMinigame = null;     
let minigameQueue = [];         
let lastPlayedInMini = null;
let miniCycles = 0 // ciklusszámláló a minigame-ben;

/* -------------------- Utility Functions -------------------- */

/**
 * Show the given screen and hide all others.
 * @param {HTMLElement} el - The screen element to show
 */
function showScreen(el){
  screen1.classList.remove('visible');
  screen2.classList.remove('visible');
  screen3.classList.remove('visible');
  el.classList.add('visible');
}

/**
 * Get URL query parameter by name.
 * @param {string} name - Parameter name
 * @returns {string|null} - Parameter value or null if not found
 */
function param(name){
  const u = new URL(location.href);
  return u.searchParams.get(name);
}

/**
 * Load a track by its ID into SCREEN1.
 * Updates audio source, track info, progress bar, and shows mini-game button if available.
 * @param {string} id - Track ID
 */
function loadTrackById(id){
  let meta = tracks[id] || extraTracks[id];
  if(!meta){ console.warn('Unknown track',id); return; }
  currentTrack = id;
  audio.src = meta.url;
  playingInfo.textContent = "¯\_(ツ)_/¯";
  playBtn.textContent = "Play";
  progFill.style.width = '0%';
  hint.textContent = "";
  showScreen(screen1);

  // MINI-GAME button
  const trackMeta = tracks[id];
  miniGameBtnWrap.innerHTML = '';
  if(trackMeta && trackMeta.minigame){
    const b = document.createElement('button');
    b.textContent = 'MINI-GAME';
    b.onclick = () => startMiniGame(trackMeta.minigame);
    miniGameBtnWrap.appendChild(b);
  }
}

/**
 * Shuffle an array in-place using Fisher-Yates algorithm.
 * @param {Array} a - Array to shuffle
 */
function shuffleArray(a){
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]]=[a[j],a[i]];
  }
}

/* -------------------- Event Listeners -------------------- */

/**
 * Play/Stop button handler.
 * Toggles playback of current audio track.
 */
playBtn.addEventListener('click', async ()=>{
  if(audio.paused){
    try {
      await audio.play();
      playBtn.textContent = "Pause";   // change Stop → Pause
    } catch(e) {
      hint.textContent = "A böngésző megakadályozta az automatikus lejátszást. Kérjük, érints a lejátszó gombot újra.";
    }
  } else {
    audio.pause();
    playBtn.textContent = "Play";      // Play when paused
  }
});

/**
 * Update progress bar as audio plays.
 */
audio.addEventListener('timeupdate', ()=>{
  if(audio.duration){
    const pct = Math.floor(100 * audio.currentTime / audio.duration);
    progFill.style.width = pct + '%';
  }
});

/**
 * Reset play button when audio ends.
 */
audio.addEventListener('ended', ()=>{ playBtn.textContent = "Play"; });

/**
 * ANSWER button handler.
 * Stops audio and shows SCREEN2 (regular track) or SCREEN3 (mini-game).
 */
answerBtn.addEventListener('click', ()=>{
  audio.pause();
  playBtn.textContent = "Play";

  if(currentMinigame){
    const meta = extraTracks[lastPlayedInMini] || tracks[lastPlayedInMini];
    miniAnswerText.textContent = `${meta.title} — ${meta.composer}`;
    showScreen(screen3);
  } else {
    const meta = tracks[currentTrack];
    answerText.textContent = `${meta.title} — ${meta.composer}`;
    showScreen(screen2);
  }
});

/**
 * BACK link handler: return from SCREEN2 to SCREEN1.
 */
backToPlay.addEventListener('click', (e)=>{
  e.preventDefault();
  showScreen(screen1);
});

/* -------------------- Mini-game Functions -------------------- */

/**
 * Start a mini-game.
 * Shuffles the mini-game tracks and starts the first one.
 * @param {string} miniName - Mini-game name (key in minigames)
 */
function startMiniGame(miniName){
  currentMinigame = miniName;
  miniCycles = 0;  // reset counter

  const mg = minigames[miniName];
  if(!mg) return;

  shuffleArray(mg.tracks);
  minigameQueue = mg.tracks.slice();

  miniCycles = 0; // reset cycle counter
  playNextInMini();
}

/**
 * Play next track in current mini-game.
 * Updates SCREEN1 and plays audio automatically if possible.
 */
function playNextInMini(){
  const mg = minigames[currentMinigame];
  
  // Stop if cycle limit reached
  if(miniCycles >= (mg?.limit || Infinity) || minigameQueue.length === 0){
    currentMinigame = null;
    showScreen(screen2);
    return;
  }

  const id = minigameQueue.shift();
  lastPlayedInMini = id;
  miniCycles++;  // increment cycle counter

  const meta = extraTracks[id];
  audio.src = meta.url;
  playingInfo.textContent = "Zene lejátszása...";
  progFill.style.width = '0%';
  showScreen(screen1);
  
  audio.play().then(()=>{ playBtn.textContent="Pause"; })
    .catch(()=>{ 
      playBtn.textContent="Play"; 
      hint.textContent="Érintsd a lejátszás gombot, hogy elinduljon a hang.";
    });
}

/**
 * NEXT button in SCREEN3: play next mini-game track.
 */
nextMiniBtn.addEventListener('click', ()=>{
  playNextInMini();
});

/**
 * EXIT button in SCREEN3: exit mini-game.
 * Returns to SCREEN2 for parent track.
 */
exitMiniBtn.addEventListener('click', ()=>{
  currentMinigame = null;
  minigameQueue = [];
  const parent = tracks[currentTrack];
  if(parent){ 
    answerText.textContent = `${parent.title} — ${parent.composer}`; 
    showScreen(screen2); 
  } else showScreen(screen1);
});

// Interactive progress bar
const progress = document.getElementById('progress');
let isDragging = false;

audio.addEventListener('loadedmetadata', ()=>{
  // Ensure duration is known
  if(audio.duration){
    progFill.style.width = (audio.currentTime / audio.duration * 100) + '%';
  }
});

audio.addEventListener('timeupdate', ()=>{
  if(!isDragging && audio.duration){
    progFill.style.width = (audio.currentTime / audio.duration * 100) + '%';
  }
});

// Click to jump
progress.addEventListener('click', (e)=>{
  if(!audio.duration) return;
  const rect = progress.getBoundingClientRect();
  let pct = (e.clientX - rect.left)/rect.width;
  pct = Math.max(0, Math.min(1, pct));
  audio.currentTime = pct*audio.duration;
});

// Drag with mouse
progress.addEventListener('mousedown', ()=>{ isDragging = true; });
document.addEventListener('mouseup', ()=>{ isDragging = false; });
document.addEventListener('mousemove', (e)=>{
  if(isDragging && audio.duration){
    const rect = progress.getBoundingClientRect();
    let pct = (e.clientX - rect.left)/rect.width;
    pct = Math.max(0, Math.min(1, pct));
    audio.currentTime = pct*audio.duration;
  }
});

// Touch for mobile
progress.addEventListener('touchstart', ()=>{ isDragging = true; });
progress.addEventListener('touchend', ()=>{ isDragging = false; });
progress.addEventListener('touchmove', (e)=>{
  if(isDragging && audio.duration){
    const touch = e.touches[0];
    const rect = progress.getBoundingClientRect();
    let pct = (touch.clientX - rect.left)/rect.width;
    pct = Math.max(0, Math.min(1, pct));
    audio.currentTime = pct*audio.duration;
    e.preventDefault();
  }
});
  
/* -------------------- Initialization -------------------- */

/**
 * On page load:
 * - Check if ?track=ID is provided in URL
 * - Load track if valid, otherwise show landing message
 */
(function init(){
  const t = param('track');
  if(t && (tracks[t] || extraTracks[t])){
    loadTrackById(t);
  } else {
    playingInfo.textContent = "Nincs megadott track. Ellenőrizd a QR kódot.";
    hint.textContent = "Próbáld beolvasni a kártyán lévő QR kódot.";
    showScreen(screen1);
  }
})();
</script>
</body>
</html>
